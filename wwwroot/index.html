<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Persian File Copier Pro</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="background-color" content="#ffffff">
    <meta name="description" content="فارسی کاپیر فایل حرفه‌ای - نرم‌افزار پیشرفته کپی و مدیریت فایل">
    <meta name="keywords" content="file copier, فایل کاپیر, مدیریت فایل, کپی فایل, فارسی">
    <meta name="author" content="Persian File Copier Team">
    
    <!-- Mobile App Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PFC Pro">
    <meta name="application-name" content="Persian File Copier Pro">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Offline Resources - All Dependencies Local -->
    <link href="/assets/css/vazirmatn.css" rel="stylesheet">
    <link href="/assets/css/sweetalert2.min.css" rel="stylesheet">
    <link href="/assets/css/animate.min.css" rel="stylesheet">
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/sweetalert2.all.min.js"></script>
    <script src="/assets/js/sortable.min.js"></script>
    
    <style>
        /* Enhanced Persian File Copier Pro CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background: #ffffff;
            --surface: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --animation-speed: 0.3s;
            
            /* Task Status Colors */
            --color-running: #10b981;
            --color-preparing: #f59e0b;
            --color-paused: #ef4444;
            --color-completed: #059669;
            --color-failed: #dc2626;
            --color-cancelled: #6b7280;
        }

        body {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            direction: rtl;
        }

        /* Main Layout */
        .main-container {
            max-width: 1600px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 1.5rem;
            min-height: calc(100vh - 140px);
        }

        /* Panel Base Styles */
        .panel-base {
            background: var(--surface);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .drives-panel {
            background: var(--surface);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .panel-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tasks Panel - Completely Redesigned */
        .tasks-panel {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            border-radius: 24px;
            padding: 0;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.1),
                0 8px 16px rgba(0,0,0,0.06),
                inset 0 1px 0 rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            min-height: 600px;
            max-height: 80vh;
        }

        .tasks-panel .panel-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 24px 24px 0 0;
            margin: 0;
            border: none;
        }

        /* Task Controls */
        .task-controls {
            background: rgba(255,255,255,0.9);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .task-control-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            min-width: 120px;
        }

        .task-control-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Tasks List Container */
        #tasks-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }

        #tasks-list::-webkit-scrollbar {
            width: 6px;
        }

        #tasks-list::-webkit-scrollbar-track {
            background: transparent;
        }

        #tasks-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        #tasks-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* Task Item - New Perfect Layout */
        .task-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95));
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(255,255,255,0.6);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--task-color, #667eea) calc(var(--progress, 0) * 1%), rgba(0,0,0,0.1) calc(var(--progress, 0) * 1%));
            transition: all 0.3s ease;
        }

        .task-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 32px rgba(0,0,0,0.12), 0 8px 16px rgba(0,0,0,0.08);
        }

        /* Task Layout Structure */
        .task-layout {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 1rem;
            padding: 1.25rem;
        }

        .task-main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Task Info Section */
        .task-info-section {
            background: rgba(0,0,0,0.03);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .task-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            background: rgba(255,255,255,0.7);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Task Progress Section */
        .task-progress-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .task-paths {
            flex: 1;
        }

        .task-path {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .path-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-left: 0.5rem;
            display: inline-block;
            min-width: 40px;
        }

        .path-value {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        .task-progress-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            min-width: 200px;
        }

        /* Progress Circle */
        .task-progress-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(var(--task-color, #667eea) calc(var(--progress, 0) * 3.6deg), rgba(0,0,0,0.1) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 3px solid rgba(255,255,255,0.9);
        }

        .task-progress-circle::before {
            content: '';
            position: absolute;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
        }

        .progress-text {
            position: relative;
            z-index: 1;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* Progress Bar */
        .task-progress-bar {
            width: 100%;
            height: 16px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--task-color, #667eea), rgba(102, 126, 234, 0.8));
            border-radius: 8px;
            transition: width 0.5s ease;
            position: relative;
        }

        .task-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            z-index: 2;
        }

        /* Task Controls Sidebar */
        .task-controls-sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem 0.5rem;
            background: rgba(0,0,0,0.04);
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.08);
            align-self: flex-start;
            min-width: 70px;
        }

        .task-action-btn {
            min-width: 48px;
            height: 48px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0;
        }

        .task-action-btn.pause-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .task-action-btn.resume-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .task-action-btn.cancel-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .task-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Task Status Colors */
        .task-item.task-running {
            --task-color: var(--color-running);
        }

        .task-item.task-preparing {
            --task-color: var(--color-preparing);
        }

        .task-item.task-paused {
            --task-color: var(--color-paused);
        }

        .task-item.task-completed {
            --task-color: var(--color-completed);
        }

        .task-item.task-failed {
            --task-color: var(--color-failed);
        }

        .task-item.task-cancelled {
            --task-color: var(--color-cancelled);
        }

        /* File List */
        .file-list {
            flex: 1;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            overflow-y: auto;
            max-height: 500px;
        }

        .file-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background var(--animation-speed);
        }

        .file-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-item.selected {
            background: rgba(102, 126, 234, 0.2);
        }

        /* Drive Items */
        .drive-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--animation-speed);
            border: 1px solid transparent;
        }

        .drive-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
            transform: translateX(-4px);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-speed);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-container {
                max-width: 1200px;
                grid-template-columns: 280px 1fr 360px;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 250px 1fr 300px;
                gap: 1rem;
                margin: 0.5rem auto;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 0.5rem;
            }
            
            .task-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .task-controls-sidebar {
                flex-direction: row;
                justify-content: center;
                min-width: auto;
                width: 100%;
            }
            
            .task-stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .task-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .task-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .task-progress-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* No Tasks Message */
        #no-tasks-message {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        #no-tasks-message .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* File Path Breadcrumb */
        .file-path-breadcrumb {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .path-text {
            font-family: monospace;
            background: rgba(0,0,0,0.05);
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* User Folders and Drives */
        .user-folders-section, .drives-section {
            margin-bottom: 1rem;
        }

        .user-folders-section h4, .drives-section h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <span>📁</span>
                <span>Persian File Copier Pro</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSettings()">⚙️ تنظیمات</button>
                <button class="btn btn-secondary" onclick="openLicense()">🔑 لایسنس</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" style="margin-right: 100px; margin-left: 100px;">
        <!-- Drives Panel -->
        <div class="drives-panel">
            <div class="panel-header">
                <h3>💾 درایوها</h3>
                <button class="btn btn-secondary" onclick="refreshDrives()" style="padding: 0.5rem;">🔄</button>
            </div>
            <div id="drives-list">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem;">در حال اسکن درایوها...</p>
                </div>
            </div>
        </div>

        <!-- Files Panel -->
        <div class="files-panel">
            <div class="panel-header">
                <h3>📁 فایل‌ها</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="refreshFiles()" style="padding: 0.5rem;">🔄</button>
                    <button class="btn btn-secondary" onclick="selectAllFiles()" style="padding: 0.5rem;">☑️</button>
                    <button class="btn btn-primary" onclick="copySelectedFiles()" style="padding: 0.5rem;">📋 کپی</button>
                </div>
            </div>
            <div class="file-list" id="file-list">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <p>درایو مورد نظر را انتخاب کنید</p>
                </div>
            </div>
        </div>

        <!-- Tasks Panel -->
        <div class="tasks-panel">
            <div class="panel-header">
                <h3>📊 مدیریت تسک‌ها</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span id="task-counter" style="font-size: 0.9rem; opacity: 0.8;">0 تسک فعال</span>
                </div>
            </div>
            
            <div class="task-controls">
                <button class="task-control-btn" onclick="pauseAllTasks()" title="توقف همه تسک‌ها">⏸️ توقف همه</button>
                <button class="task-control-btn" onclick="resumeAllTasks()" title="ادامه همه تسک‌ها">▶️ ادامه همه</button>
                <button class="task-control-btn" onclick="cancelAllTasks()" title="لغو همه تسک‌ها">⏹️ لغو همه</button>
            </div>
            
            <div id="tasks-list">
                <div id="no-tasks-message">
                    <div class="icon">📋</div>
                    <h4>هیچ تسکی در حال اجرا نیست</h4>
                    <p>فایل‌هایی را انتخاب کرده و عملیات کپی را شروع کنید</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connection-status" style="display: none;">
        🟢 متصل به سرور
    </div>

    <script>
        // Global Variables
        let selectedFiles = [];
        let currentPath = '';
        let taskPollingIntervals = {};
        let isConnected = false;

        // Initialize App
        $(document).ready(function() {
            console.log('🚀 Persian File Copier Pro - Initializing...');
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadDrives();
                await loadTasks();
                setupWebSocket();
                checkConnection();
                
                console.log('✅ App initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing app:', error);
                showNotification('خطا در راه‌اندازی برنامه', 'error');
            }
        }

        // Task Status Helper Functions
        function getTaskStatusString(numericStatus) {
            const statusMap = {
                0: 'preparing',
                1: 'running', 
                2: 'paused',
                3: 'completed',
                4: 'failed',
                5: 'cancelled'
            };
            return statusMap[numericStatus] || 'unknown';
        }

        function getTaskStatusClass(status) {
            const statusString = typeof status === 'number' ? getTaskStatusString(status) : status;
            const classes = {
                'running': 'task-running',
                'preparing': 'task-preparing', 
                'paused': 'task-paused',
                'completed': 'task-completed',
                'failed': 'task-failed',
                'cancelled': 'task-cancelled'
            };
            return classes[statusString] || 'task-unknown';
        }

        function getTaskStatusText(status) {
            const statusString = typeof status === 'number' ? getTaskStatusString(status) : status;
            const texts = {
                'running': 'در حال اجرا',
                'preparing': 'در حال آماده‌سازی',
                'paused': 'متوقف شده',
                'completed': 'تکمیل شده',
                'failed': 'ناموفق',
                'cancelled': 'لغو شده'
            };
            return texts[statusString] || statusString;
        }

        // Create Perfect Task Element
        function createTaskElementForPanel(taskId, task) {
            const statusClass = getTaskStatusClass(task.status);
            const progress = Math.round(task.progress || 0);
            const speed = formatFileSize(task.speed || 0) + '/s';
            const eta = formatTime(task.eta || 0);
            
            // Extract file paths
            const sourcePath = task.source_files ? (Array.isArray(task.source_files) ? task.source_files[0] : task.source_files) : 'نامشخص';
            const destPath = task.destination || 'نامشخص';
            
            // Calculate sizes
            const copiedSize = formatFileSize(task.copied_size || 0);
            const totalSize = formatFileSize(task.total_size || 0);
            
            const element = $(`
                <div class="task-item ${statusClass}" data-task-id="${taskId}" style="--progress: ${progress}">
                    <div class="task-layout">
                        <div class="task-main-content">
                            <!-- Task Info Section (Bottom) -->
                            <div class="task-info-section">
                                <div class="task-stats-grid">
                                    <div class="stat-item">
                                        <span>📊</span>
                                        <span>${task.copied_files || 0}/${task.total_files || 0} فایل</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>📦</span>
                                        <span>${copiedSize}/${totalSize}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>⚡</span>
                                        <span>${speed}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>⏱️</span>
                                        <span>${eta}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Task Progress Section (Middle) -->
                            <div class="task-progress-section">
                                <div class="task-paths">
                                    <div class="task-path">
                                        <span class="path-label">مبدا:</span>
                                        <span class="path-value">${sourcePath}</span>
                                    </div>
                                    <div class="task-path">
                                        <span class="path-label">مقصد:</span>
                                        <span class="path-value">${destPath}</span>
                                    </div>
                                </div>
                                <div class="task-progress-visual">
                                    <div class="task-progress-circle">
                                        <span class="progress-text">${progress}%</span>
                                    </div>
                                    <div class="task-progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                        <div class="task-progress-text">${progress}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Task Controls Sidebar (Right) -->
                        <div class="task-controls-sidebar">
                            ${getTaskActionButtons(taskId, task.status)}
                        </div>
                    </div>
                </div>
            `);
            
            return element;
        }

        // Task Action Buttons
        function getTaskActionButtons(taskId, status) {
            let buttons = '';
            const statusString = typeof status === 'number' ? getTaskStatusString(status) : status;
            
            if (statusString === 'running') {
                buttons += `<button class="task-action-btn pause-btn" onclick="pauseTask('${taskId}')" title="توقف">⏸️</button>`;
                buttons += `<button class="task-action-btn cancel-btn" onclick="cancelTask('${taskId}')" title="لغو">⏹️</button>`;
            } else if (statusString === 'paused') {
                buttons += `<button class="task-action-btn resume-btn" onclick="resumeTask('${taskId}')" title="ادامه">▶️</button>`;
                buttons += `<button class="task-action-btn cancel-btn" onclick="cancelTask('${taskId}')" title="لغو">⏹️</button>`;
            } else if (statusString === 'preparing') {
                buttons += `<button class="task-action-btn cancel-btn" onclick="cancelTask('${taskId}')" title="لغو">⏹️</button>`;
            } else if (statusString === 'completed') {
                buttons += `<button class="task-action-btn resume-btn" onclick="retryTask('${taskId}')" title="تکرار">🔄</button>`;
                buttons += `<button class="task-action-btn cancel-btn" onclick="removeTask('${taskId}')" title="حذف">🗑️</button>`;
            } else if (statusString === 'failed') {
                buttons += `<button class="task-action-btn resume-btn" onclick="retryTask('${taskId}')" title="تلاش مجدد">🔄</button>`;
                buttons += `<button class="task-action-btn cancel-btn" onclick="removeTask('${taskId}')" title="حذف">🗑️</button>`;
            }
            
            return buttons;
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                
                console.log('📋 Loaded tasks:', data);
                displayTasks(data.tasks || {});
                updateTaskCounter(data.tasks || {});
                
            } catch (error) {
                console.error('❌ Error loading tasks:', error);
                showNotification('خطا در بارگیری تسک‌ها', 'error');
            }
        }

        // Display Tasks
        function displayTasks(tasks) {
            const tasksList = $('#tasks-list');
            const noTasksMessage = $('#no-tasks-message');
            
            if (!tasks || Object.keys(tasks).length === 0) {
                noTasksMessage.show();
                tasksList.children('.task-item').remove();
                return;
            }
            
            noTasksMessage.hide();
            
            // Clear existing tasks and add new ones
            tasksList.children('.task-item').remove();
            
            Object.entries(tasks).forEach(([taskId, task]) => {
                const statusString = getTaskStatusString(task.status);
                task.statusString = statusString;
                
                console.log(`📝 Task ${taskId}: status=${task.status} (${statusString})`);
                
                if (['running', 'preparing', 'paused'].includes(statusString)) {
                    startTaskPolling(taskId);
                }
                
                const taskElement = createTaskElementForPanel(taskId, task);
                tasksList.append(taskElement);
            });
        }

        // Update Task Counter
        function updateTaskCounter(tasks) {
            const activeTasks = Object.values(tasks).filter(task => {
                const statusString = getTaskStatusString(task.status);
                return ['running', 'preparing', 'paused'].includes(statusString);
            });
            
            $('#task-counter').text(`${activeTasks.length} تسک فعال`);
        }

        // Task Polling
        function startTaskPolling(taskId) {
            if (taskPollingIntervals[taskId]) {
                clearInterval(taskPollingIntervals[taskId]);
            }
            
            taskPollingIntervals[taskId] = setInterval(async () => {
                try {
                    const response = await fetch(`/api/tasks/${taskId}`);
                    if (response.ok) {
                        const taskData = await response.json();
                        updateTaskInRealTime(taskId, taskData);
                        
                        const statusString = getTaskStatusString(taskData.status);
                        if (['completed', 'failed', 'cancelled'].includes(statusString)) {
                            console.log(`✅ Task ${taskId} finished with status: ${taskData.status} (${statusString})`);
                            stopTaskPolling(taskId);
                            await loadTasks(); // Refresh all tasks
                        }
                    }
                } catch (error) {
                    console.error(`❌ Error polling task ${taskId}:`, error);
                }
            }, 1000);
        }

        function stopTaskPolling(taskId) {
            if (taskPollingIntervals[taskId]) {
                clearInterval(taskPollingIntervals[taskId]);
                delete taskPollingIntervals[taskId];
            }
        }

        // Update Task in Real Time
        function updateTaskInRealTime(taskId, taskData) {
            const taskElement = $(`.task-item[data-task-id="${taskId}"]`);
            if (taskElement.length === 0) return;
            
            const progress = Math.round(taskData.progress || 0);
            const speed = formatFileSize(taskData.speed || 0) + '/s';
            const eta = formatTime(taskData.eta || 0);
            const copiedSize = formatFileSize(taskData.copied_size || 0);
            const totalSize = formatFileSize(taskData.total_size || 0);
            
            // Update progress
            taskElement.css('--progress', progress);
            taskElement.find('.progress-text').text(`${progress}%`);
            taskElement.find('.progress-fill').css('width', `${progress}%`);
            taskElement.find('.task-progress-text').text(`${progress}%`);
            
            // Update stats
            taskElement.find('.stat-item').eq(0).find('span').eq(1).text(`${taskData.copied_files || 0}/${taskData.total_files || 0} فایل`);
            taskElement.find('.stat-item').eq(1).find('span').eq(1).text(`${copiedSize}/${totalSize}`);
            taskElement.find('.stat-item').eq(2).find('span').eq(1).text(speed);
            taskElement.find('.stat-item').eq(3).find('span').eq(1).text(eta);
            
            // Update status class
            const statusString = getTaskStatusString(taskData.status);
            const newStatusClass = getTaskStatusClass(taskData.status);
            
            taskElement.removeClass('task-running task-preparing task-paused task-completed task-failed task-cancelled');
            taskElement.addClass(newStatusClass);
            
            // Update buttons if status changed
            const currentButtons = taskElement.find('.task-controls-sidebar').html();
            const newButtons = getTaskActionButtons(taskId, taskData.status);
            if (currentButtons !== newButtons) {
                taskElement.find('.task-controls-sidebar').html(newButtons);
            }
        }

        // Task Control Functions
        async function pauseTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/pause`, { method: 'POST' });
                if (response.ok) {
                    showNotification('تسک متوقف شد', 'success');
                    await loadTasks();
                } else {
                    throw new Error('Failed to pause task');
                }
            } catch (error) {
                console.error('Error pausing task:', error);
                showNotification('خطا در متوقف کردن تسک', 'error');
            }
        }

        async function resumeTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/resume`, { method: 'POST' });
                if (response.ok) {
                    showNotification('تسک ادامه یافت', 'success');
                    await loadTasks();
                } else {
                    throw new Error('Failed to resume task');
                }
            } catch (error) {
                console.error('Error resuming task:', error);
                showNotification('خطا در ادامه دادن تسک', 'error');
            }
        }

        async function cancelTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
                if (response.ok) {
                    showNotification('تسک لغو شد', 'success');
                    stopTaskPolling(taskId);
                    await loadTasks();
                } else {
                    throw new Error('Failed to cancel task');
                }
            } catch (error) {
                console.error('Error canceling task:', error);
                showNotification('خطا در لغو تسک', 'error');
            }
        }

        async function pauseAllTasks() {
            try {
                const response = await fetch('/api/tasks/pause-all', { method: 'POST' });
                if (response.ok) {
                    showNotification('همه تسک‌ها متوقف شدند', 'success');
                    await loadTasks();
                } else {
                    throw new Error('Failed to pause all tasks');
                }
            } catch (error) {
                console.error('Error pausing all tasks:', error);
                showNotification('خطا در متوقف کردن همه تسک‌ها', 'error');
            }
        }

        async function resumeAllTasks() {
            try {
                const response = await fetch('/api/tasks/resume-all', { method: 'POST' });
                if (response.ok) {
                    showNotification('همه تسک‌ها ادامه یافتند', 'success');
                    await loadTasks();
                } else {
                    throw new Error('Failed to resume all tasks');
                }
            } catch (error) {
                console.error('Error resuming all tasks:', error);
                showNotification('خطا در ادامه دادن همه تسک‌ها', 'error');
            }
        }

        async function cancelAllTasks() {
            try {
                const response = await fetch('/api/tasks/cancel-all', { method: 'POST' });
                if (response.ok) {
                    showNotification('همه تسک‌ها لغو شدند', 'success');
                    Object.keys(taskPollingIntervals).forEach(taskId => stopTaskPolling(taskId));
                    await loadTasks();
                } else {
                    throw new Error('Failed to cancel all tasks');
                }
            } catch (error) {
                console.error('Error canceling all tasks:', error);
                showNotification('خطا در لغو همه تسک‌ها', 'error');
            }
        }

        // Load Drives
        async function loadDrives() {
            try {
                const response = await fetch('/api/drives');
                const drives = await response.json();
                displayDrives(drives);
            } catch (error) {
                console.error('❌ Error loading drives:', error);
                showNotification('خطا در بارگیری درایوها', 'error');
            }
        }

        function displayDrives(drives) {
            const driveColors = [
                'rgba(255, 99, 132, 0.1)', 'rgba(54, 162, 235, 0.1)', 'rgba(255, 205, 86, 0.1)',
                'rgba(75, 192, 192, 0.1)', 'rgba(153, 102, 255, 0.1)', 'rgba(255, 159, 64, 0.1)',
                'rgba(199, 199, 199, 0.1)', 'rgba(83, 102, 255, 0.1)', 'rgba(255, 99, 255, 0.1)',
                'rgba(99, 255, 132, 0.1)', 'rgba(255, 206, 84, 0.1)', 'rgba(54, 162, 180, 0.1)'
            ];

            const userFolders = [
                { name: 'دسکتاپ', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Desktop`, icon: '🖥️' },
                { name: 'اسناد', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Documents`, icon: '📄' },
                { name: 'دانلودها', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Downloads`, icon: '⬇️' },
                { name: 'تصاویر', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Pictures`, icon: '🖼️' },
                { name: 'موسیقی', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Music`, icon: '🎵' },
                { name: 'ویدیوها', path: `${process.env.USERPROFILE || 'C:\\Users\\User'}\\Videos`, icon: '🎬' }
            ];

            let html = '<div class="user-folders-section"><h4>🏠 پوشه‌های کاربر</h4>';
            userFolders.forEach((folder, index) => {
                const folderColor = driveColors[index % driveColors.length];
                html += `
                    <div class="drive-item" onclick="loadFiles('${folder.path}')" style="background-color: ${folderColor};">
                        <span style="margin-left: 0.5rem; font-size: 1.2rem;">${folder.icon}</span>
                        <div>
                            <div style="font-weight: 600;">${folder.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${folder.path}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += '<div class="drives-section"><h4>💾 درایوها</h4>';
            const drivesHtml = drives.map((drive, index) => {
                const driveColor = driveColors[(index + userFolders.length) % driveColors.length];
                return `
                    <div class="drive-item" onclick="loadFiles('${drive.path}')" style="background-color: ${driveColor};">
                        <span style="margin-left: 0.5rem; font-size: 1.2rem;">💾</span>
                        <div>
                            <div style="font-weight: 600;">${drive.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${formatFileSize(drive.available_space)} آزاد از ${formatFileSize(drive.total_space)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            html += drivesHtml + '</div>';

            $('#drives-list').html(html);
        }

        // Load Files
        async function loadFiles(path) {
            try {
                currentPath = path;
                $('#file-list').html('<div style="text-align: center; padding: 2rem;"><div class="loading"></div><p style="margin-top: 1rem;">در حال بارگیری...</p></div>');
                
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                const files = await response.json();
                
                displayFiles(files);
            } catch (error) {
                console.error('❌ Error loading files:', error);
                $('#file-list').html('<div style="text-align: center; padding: 2rem; color: red;">خطا در بارگیری فایل‌ها</div>');
            }
        }

        function displayFiles(files) {
            const fileListHtml = files.map(file => {
                const pathParts = file.path.split(/[\\\/]/).filter(part => part);
                const breadcrumbPath = pathParts.length > 3
                    ? `${pathParts[0]}\\...\\${pathParts.slice(-2).join('\\')}`
                    : file.path;
                
                return `
                    <div class="file-item" data-path="${file.path}" data-size="${file.size}" data-type="${file.type || 'file'}" draggable="true">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox" class="file-checkbox" onchange="updateSelectedFiles()">
                            <span style="font-size: 1.2rem;">${getFileIcon(file.type, file.name)}</span>
                            <div class="file-info" style="flex: 1;">
                                <div class="file-name" title="${file.path}">${file.name}</div>
                                <div class="file-path-breadcrumb" title="${file.path}">
                                    <span class="path-text">${breadcrumbPath}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${file.type === 'directory' ? 'پوشه' : formatFileSize(file.size)}
                                    ${file.modified ? ` • ${new Date(file.modified).toLocaleDateString('fa-IR')}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            $('#file-list').html(fileListHtml);
            selectedFiles = [];
        }

        // File Operations
        function updateSelectedFiles() {
            selectedFiles = [];
            $('.file-checkbox:checked').each(function() {
                const fileItem = $(this).closest('.file-item');
                selectedFiles.push({
                    path: fileItem.data('path'),
                    name: fileItem.find('.file-name').text(),
                    size: fileItem.data('size'),
                    type: fileItem.data('type')
                });
            });
            
            console.log('Selected files:', selectedFiles);
        }

        function selectAllFiles() {
            const allChecked = $('.file-checkbox:checked').length === $('.file-checkbox').length;
            $('.file-checkbox').prop('checked', !allChecked);
            updateSelectedFiles();
        }

        async function copySelectedFiles() {
            if (selectedFiles.length === 0) {
                showNotification('لطفاً فایل‌هایی را انتخاب کنید', 'warning');
                return;
            }

            const result = await Swal.fire({
                title: 'انتخاب مقصد',
                text: 'مسیر مقصد برای کپی فایل‌ها را وارد کنید:',
                input: 'text',
                inputPlaceholder: 'مثال: D:\\Backup',
                showCancelButton: true,
                confirmButtonText: 'شروع کپی',
                cancelButtonText: 'لغو',
                inputValidator: (value) => {
                    if (!value) {
                        return 'لطفاً مسیر مقصد را وارد کنید!';
                    }
                }
            });

            if (result.isConfirmed && result.value) {
                const destinationPath = result.value;
                
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            type: 'copy',
                            source_files: selectedFiles.map(f => f.path),
                            destination: destinationPath,
                            source_device: currentPath,
                            dest_device: destinationPath
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`تسک کپی با موفقیت ایجاد شد (ID: ${result.task_id})`, 'success');
                        
                        // Clear selection
                        selectedFiles = [];
                        $('.file-checkbox').prop('checked', false);
                        
                        // Refresh tasks
                        await loadTasks();
                    } else {
                        throw new Error('Failed to create copy task');
                    }
                } catch (error) {
                    console.error('Error creating copy task:', error);
                    showNotification('خطا در ایجاد تسک کپی', 'error');
                }
            }
        }

        // Utility Functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (seconds === 0 || !seconds) return '0 ثانیه';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours} ساعت ${minutes} دقیقه`;
            } else if (minutes > 0) {
                return `${minutes} دقیقه ${secs} ثانیه`;
            } else {
                return `${secs} ثانیه`;
            }
        }

        function getFileIcon(type, name) {
            if (type === 'directory') return '📁';
            
            const ext = name.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': '📄', 'doc': '📄', 'docx': '📄', 'txt': '📄',
                'jpg': '🖼️', 'jpeg': '🖼️', 'png': '🖼️', 'gif': '🖼️',
                'mp4': '🎬', 'avi': '🎬', 'mkv': '🎬', 'mov': '🎬',
                'mp3': '🎵', 'wav': '🎵', 'flac': '🎵',
                'zip': '📦', 'rar': '📦', '7z': '📦',
                'exe': '⚙️', 'msi': '⚙️'
            };
            
            return iconMap[ext] || '📄';
        }

        function showNotification(message, type = 'info') {
            const icon = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            
            Swal.fire({
                icon: icon,
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        // WebSocket Setup
        function setupWebSocket() {
            // This would connect to SignalR hub for real-time updates
            console.log('🔌 Setting up WebSocket connection...');
            
            // Simulated connection check
            setTimeout(() => {
                isConnected = true;
                $('#connection-status').show().text('🟢 متصل به سرور');
            }, 1000);
        }

        function checkConnection() {
            setInterval(() => {
                if (isConnected) {
                    $('#connection-status').show();
                } else {
                    $('#connection-status').hide();
                }
            }, 5000);
        }

        // Additional Functions (Settings, License, etc.)
        function openSettings() {
            showNotification('تنظیمات در نسخه آینده اضافه خواهد شد', 'info');
        }

        function openLicense() {
            showNotification('مدیریت لایسنس در نسخه آینده اضافه خواهد شد', 'info');
        }

        function refreshDrives() {
            loadDrives();
            showNotification('لیست درایوها به‌روزرسانی شد', 'success');
        }

        function refreshFiles() {
            if (currentPath) {
                loadFiles(currentPath);
                showNotification('لیست فایل‌ها به‌روزرسانی شد', 'success');
            }
        }
    </script>
</body>
</html>